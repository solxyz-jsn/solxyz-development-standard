# CI/CD基盤アプリケーション

## CI/CDを利用するために必要なこと

### CI/CDの導入コスト

`CI/CD`は、Continuous Integration(継続的インテグレーション)とContinuous Deployment(継続的デプロイ)の略です。これは開発の過程を自動化するための方法論です。

`CI/CD`を実現するためのさまざまなアプリケーションが存在します。これらのアプリケーションは大きく分けて、セルフホスティング（オンプレミス）型とクラウド（SaaS）型の2種類があります。

使用するSaaSの`CI/CD`サービスによっては、利用頻度が低ければ無料枠に収まる場合もありますが、多くの場合有料になります。

自分でインストールする場合は実行するサーバーの費用、またそのアプリケーションによっては、別途ライセンス料が必要です。

### CI/CD用のスクリプトを作成

`CI/CD`を用いたプロセスの自動化を実現するには、「ビルド」、「テスト」、「デプロイ」などのプロセスを実行するスクリプトを書く必要があります。

#### ビルドの自動化

ビルドの自動化を行うには、JavaであればMavenやGradle、Node.jsであればnpmやyarnなどのビルドシステムを使用します。

`CI/CD`のためには、コマンドラインで実行する必要があります。

#### テストの自動化

テストの自動化するためには、テストコードを作成しなくてはなりません。

テストには使用するプログラミング言語ごとにテストフレームワークが存在します。

たとえばJavaであればJUnit、Node.jsであればJestなどです。

これらのテストフレームワークを使用して、コードのテストを自動化する必要があります。

#### デプロイの自動化

デプロイの自動化を行うには、デプロイ先の環境に合わせたスクリプトを作成する必要があります。

scpやrsyncなどのコマンドを使用して、デプロイ先の環境にコードを転送することができます。

Dockerを使用している場合は、Dockerイメージを作成し、Dockerレジストリにプッシュすることで、デプロイ先の環境にコードを転送することができます。

さまざまな方法がありますが、デプロイ先の環境により、使用する方法が異なります。

### CI/CDパイプライン

CI/CDパイプラインは、`CI/CD`の導入によって自動化した一連のプロセスのことです。

自動化を行う対象は、プロジェクトのニーズによって異なります。

たとえば、ビルドエラーが起きないようにするために「ビルド」や「テスト」を自動化することや、コードの品質を保つためにコードスタイルのチェックや脆弱性診断を自動化することもあります。

共通しているのは、全員で共有しているブランチにコードをマージする前に、自動で「ビルド」や「テスト」を実行することで、コードの品質や開発生産性を落とさないようにすることです。

不正なコードにより、「ビルド」が成功していたとしても「テスト」が失敗した場合は、マージを禁止することができます。

各タスクは手動で実行されることがありますが、タスク間の処理も自動化することでCI/CDパイプラインの効果をより高めることができます。

## CI/CDを導入するために必要な環境

### 1. バージョン管理システム

CI/CDパイプラインは、リポジトリからソースコードの変更を検知し、取得します。

GitHubやGiteaなどのGitホスティングサービスでは、ソースコードの更新を検知してCI/CDパイプラインを実行する機能を有しています。

すべてのGitホスティングサービスに、CI/CDパイプラインを実行する機能があるわけではありません。

### 2. ビルドシステム

ビルドシステムは、ソースコードを取得し、必要な依存関係を解決して、アプリケーションをビルドするための環境を提供します。

使用している言語によって扱われるビルドシステムは異なります。

Javaであれば、MavenやGradle、Node.jsであればnpmやyarnなどです。

### 3. テストフレームワーク

テストフレームワークは、アプリケーションのテストをするためのテストコードによる実行環境を提供します。

プログラミング言語によってそのフレームワークは数多くの選択肢があります。

テストとは、単体テスト、結合テスト、システムテストを始めとしたシステムに不具合がないかを検証するテストから、性能テストやペネトレーションテストなどシステムが運用に耐えられるかのテストなどその種類はさまざまです。

すべての種類のテストを自動化すると、コードの変更時のテストコードの修正範囲が広くなり、かえって余分な時間が掛かってしまうこともあるため、安易にすべてのテストの自動化を決定するべきではありません。

繰り返しテストを実行する可能性があるか、どの程度の時間がかかるか、どの程度のコストを割くことができるかなどのプロジェクトのニーズによって、自動化するテストの種類を決定する必要があります。

単体テストは、コードの変更に伴って必ず行われるテスト工程です。テストコードの実装、エビデンスの取得からそのレビューまで時間と手間のかかる作業で何度も繰り返すことが多いため、自動化することを推奨します。

単体テストのテストフレームワークとして、JavaであればJUnit、Node.jsであればJestなどがあげられます。

結合テストでは、PlaywrightなどをE2Eテストフレームワークとして使用します。

性能テストでは、JMeterやクラウドプロバイダーが提供しているツールを使用します。

適切なテストフレームワークを選択することで、テストの自動化にかかるコストを削減することができます。

### 4. CI/CD基盤アプリケーション

`CI/CD`基盤アプリケーションは上記の「バージョン管理システム」、「ビルドシステム」、「テストフレームワーク」を利用して、`CI/CD`の各プロセスを実行するタイミングや実行を制御します。

さまざまなサービスが公開されており、使用している言語やフレームワーク等の開発環境や、どこまでの機能を必要とするか、どの程度のコストを割くことができるかなどのプロジェクトのニーズによって最適なものは変わリます。

ソルクシーズスタンダードでは、GitHub Actionsと互換のあるGitea Actionsの導入方法を解説しています。

## CI/CDでどのサービスを使用するかを選ぶときに考慮すべきこと

`CI/CD`のサービスを選択する際の主な意思決定要因を次に示します。

- セルフホストかSaaSか
- 開発環境に対応しているか
- コンテナのサポート
- Pipeline as Code
- コスト
- デプロイ時のセキュリティ
- その他

### 1. セルフホストかSaaSか

プロジェクトのルールでSaaSが禁止されている場合以外、基本的にSaaSを選ぶことをお勧めします。

理由として、自分たちでセットアップを行うセルフホストの場合は、そのサーバー等のインフラの準備・管理にコストを割く必要があるためです。

セルフホストをする場合、OSSが商用利用可能か、ライセンスに注意してください。

### 2. 開発環境に対応しているか

使用しているプログラミング言語や、バージョン管理システム、テストフレームワークに対応しているかどうかは、CI/CD基盤アプリケーションに依存しています。

多くの場合、Linuxで動作するため、shellスクリプトで動作するものはほぼ動作すると考えてよいでしょう。

ただし、動いているLinuxディストリビューションやOSのバージョンによっては動作しない場合もあります。

利用するプログラミング言語に対応している場合でも、フレームワークには対応していない場合もあるため注意が必要です。

特定のプログラミング言語やツールに特化したサービスも存在しています。

ケースバイケースで使い分けることで、より効率的に`CI/CD`を実現することができます。

### 3. コンテナのサポート

コンテナ環境にて、ビルドやテストを行うと、ホスト環境に依存しない環境で実行できるため、環境の差異によるテストの失敗を防ぐことができます。

コンテナにはアプリケーションのコードだけでなく、その実行に必要なライブラリや依存関係も含まれるため、開発環境、テスト環境、本番環境など、異なる環境での動作が一致します。

また、それぞれのアプリケーションやサービスが独立したコンテナ内で動作するため、他のアプリケーションの変更や問題が直接影響を及ぼすことが少なくなります。

ただし、コンテナ化が環境差異を完全に解消するわけではありません。環境依存の障害には、ホストOSや物理的なインフラストラクチャ、ネットワーク設定など、コンテナの外部に依存する要素も存在します。

しかし、アプリケーションのランタイム環境に関する多くの差異は、コンテナ技術によって軽減または解消されるでしょう。

### 4. Pipeline as Code

CI内の各工程のジョブ管理をコードで行う、という概念のことを指します。

各工程のジョブ設定をコードではなくGUIで行う場合、誰でも気軽にジョブの作成、実行、閲覧が可能です。

しかしその反面、ジョブの「履歴管理」「差分管理」「再利用」が難しいという課題があります。ジョブの「履歴管理」「差分管理」「再利用」ができない場合、CI/CDシステムの維持・メンテナンスをする際、特定の人しか行うことができないという障害が発生する可能性が高くなってします。

一方で、ジョブ設定をコードで行っている製品の場合、はじめの設定は難易度は多少上がりますが、コードによってジョブの「履歴管理」「差分管理」「再利用」が可能なため、維持・メンテナンスをしやすくなります。

CI/CDは変化が激しい開発手法で導入されることが多く、メンテナンス性を重視されやすいため、現在はPipeline as Codeを取り入れている製品がほとんどで、そのほうが選ばれやすい傾向にあります。

### 5. コスト

CI/CDシステムは、目的が汎用的なため、非常に似た製品が多数存在しています。

例えば、GitHubでコードを管理している場合、CIの製品の選択肢として次のものが挙げられます。

- `GitHub Actions`： GitHubが提供しているCI/CDサービス
- `Circle CI`： SaaS型のCI/CDサービス
- `Travis CI`： SaaS型のCI/CDサービス

これらの違いは、利用に必要なコストや、サポートの内容、セキュリティ、使用感などが挙げられます。

達成する目標は、CIの実行のため、プロジェクトの性質やアサインされた人員と照らし合わせて比較を行い、最適なものを選択することが重要です。

ソルクシーズスタンダードでは、GitHub Actionsと互換のあるGitea Actionsの導入方法を解説しています。
