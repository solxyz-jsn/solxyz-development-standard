# 冪等性

REST APIを設計する際、冪等性は重要な概念の1つです。冪等性とは、同じリクエストを複数回送信しても、結果が同じになるという性質を指します。冪等性を適切に実装することで、APIの信頼性と予測可能性が向上し、クライアントはより安全にAPIを利用できるようになります。

## HTTPメソッド

RESTful APIでは、HTTPメソッドを適切に選択することが冪等性の実現に重要な役割を果たします。

- **GET**: GETメソッドは、リソースの取得に使用されます。GETリクエストは冪等性をもつべきです。つまり、同じGETリクエストを複数回送信しても、結果は同じになります。GETリクエストによってサーバー上の状態が変更されることはありません。

- **PUT**: PUTメソッドは、リソースの作成または更新に使用されます。PUTリクエストは冪等性をもつべきです。同じPUTリクエストを複数回送信しても、結果は同じになります。PUTリクエストによって、指定されたリソースが更新されます。

- **DELETE**: DELETEメソッドは、リソースの削除に使用されます。DELETEリクエストは冪等性をもつべきです。同じDELETEリクエストを複数回送信しても、結果は同じになります。DELETEリクエストによって、指定されたリソースが削除されます。

- **POST**: POSTメソッドは、リソースの作成や複雑な操作に使用されます。通常、POSTリクエストは冪等性を持ちません。同じPOSTリクエストを複数回送信すると、副作用の発生につながる可能性があります。ただし、POSTリクエストに冪等性を持たせることは可能ですが、適切な設計と実装が必要です。

## リソースの一意性

冪等性を実現するためには、リソースの一意性を保証する必要があります。APIの設計において、リソースを一意に識別できるようにすることが重要です。

- リソースの一意性を保証するために、適切なリソース識別子を使用してください。一般的には、UUID（Universally Unique Identifier）、連番、ナチュラルキーなどが使用されます。

- PUTやDELETEメソッドを使用する際は、リクエストURLやリクエストボディに、対象となるリソースを一意に特定できる情報を含めてください。これにより、同じリクエストを複数回送信した場合でも、同一のリソースに対する操作の実行が保証されます。

## 副作用の管理

APIの操作によって副作用が発生する場合、冪等性を保証するのが難しくなります。副作用とは、リソースの状態変更以外の影響を指します。たとえば、メールの送信や外部サービスの呼び出しなどが副作用に該当します。

- 副作用を伴う操作は、原則としてPOSTメソッドで実装し、冪等性を持たせないようにしてください。これにより、クライアントは副作用の発生を意識して、適切にリクエストを送信できます。

- 副作用を伴う操作の実行結果は、適切にエラーハンドリングし、クライアントに通知することが重要です。リクエストが失敗した場合や、副作用の発生に問題があった場合は、適切なエラーレスポンスを返してください。

- 必要に応じて、リクエストの重複検知などの対策を実装してください。たとえば、リクエストにユニークなIDを付与し、サーバー側でそのIDを追跡することで、重複リクエストを検知できます。

## ビジネスロジックの考慮

APIの設計では、ビジネスロジックの要件も考慮する必要があります。冪等性の適用範囲は、ビジネスロジックに応じて決定してください。

- 決済処理のようなビジネスクリティカルな操作では、厳密な冪等性が求められます。同じリクエストを複数回送信しても、決済が重複して行われないようにする必要があります。

- ログの記録などの操作では、厳密な冪等性は必ずしも必要ありません。

- ビジネスロジックの要件に応じて、冪等性の適用範囲を適切に判断してください。

## クライアントの期待

APIを利用するクライアントの期待も考慮する必要があります。クライアントが冪等性を期待している場合、それに合わせてAPIを設計することが望ましいでしょう。

- APIのドキュメントや利用ガイドラインで、冪等性の動作を明確に説明してください。クライアントがAPIの動作を理解し、適切にリクエストを送信できるようにします。

- クライアントが冪等性を期待しているエンドポイントでは、冪等性を実現するための設計と実装を行ってください。

## エラーハンドリング

冪等性に関連するエラーは、適切にハンドリングし、クライアントに通知することが重要です。

- リクエストの重複検知などの対策が必要な場合、適切なエラーレスポンスを返してください。たとえば、重複リクエストが検知された場合は、適切なHTTPステータスコード（例： `409 Conflict`）とエラーメッセージを返します。

- エラーレスポンスには、エラーの原因や対処方法を含めてください。クライアントがエラーを理解し、適切に対処できるようにします。

## テストとドキュメンテーション

冪等性に関する動作を検証するために、適切なテストを実施してください。

- 冪等性に関するテストケースを作成し、APIの動作を検証してください。同じリクエストを複数回送信した場合の動作をテストし、期待される結果が得られることを確認します。

- APIドキュメントや利用ガイドラインで、冪等性の動作を明確に説明してください。サンプルコードや使用例を提供し、クライアントが冪等性を理解しやすいようにします。
