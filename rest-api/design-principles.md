# 設計原則

REST APIをはじめとするWeb APIはその性質上、多くのエンドポイントを提供します。
そのため、シンプルで整合性があり、使いやすいAPIを提供しなければ、利用者にとって使いにくいAPIとなってしまいます。

REST APIの設計は、一般的なWebアプリケーションの設計とは異なる点がいくつか存在します。

本ドキュメントでは、REST APIの設計において重要な原則を解説します。

※ 言語特有の記法や一般的なシステム設計に関しては解説致しません。

## RESTの原則

REST APIは、インターフェースとメソッドの観点から設計されています。

一貫性のないエンドポイントが追加された場合、APIの構造が複雑になります。
複雑なAPI構造は、利用者に学習コストや作業負荷を増加させ、バグの発生の原因になります。

[REST](https://ja.wikipedia.org/wiki/Representational_State_Transfer)のアーキテクチャスタイルは、主にHTTP/1.1で動作するように設計されています。
RESTの原則に従うことで、APIの設計における問題の対処に役立ちます。

そのコア原則は、少数のメソッドを使用して操作可能な名前付きリソースを定義することです。

リソースとメソッドはそれぞれ、APIの「名詞」、「動詞」と呼ばれます。
HTTPプロトコルでは、リソース名はURLに必然的にマッピングされ、メソッドはHTTPメソッド`POST`、`GET`、`PUT`、`PATCH`、`DELETE`に必然的にマッピングされます。

開発者はリソースとその関係に焦点を当て、標準的なメソッドを使用することで、学習内容を最小限に抑えられます。

## リソース指向の設計アプローチ

### リソース

通常、リソース指向のAPIは、各ノードがシンプルリソースかコレクションリソースのいずれかで構成されるリソース階層としてモデル化されます。これらのリソースは、一般的にJSONフォーマットで表現されます。JSONでは、`string`、`number`、`boolean`、`object`、`array`、`null`といったデータ型を利用できます。

例として、次のようなリソースがあります。`user`はシンプルリソースです。

```json: example
{
    "user": {
        "id": "123",
        "name": "Alice",
    }
}
```

`users`はコレクションリソースです。

```json: collection-resource
{
    "users": [
        {
            "id": "123",
            "name": "Alice"
        },
        {
            "id": "456",
            "name": "Bob"
        }
    ]
}
```

便宜上、通常はこれらをそれぞれリソースとコレクションと呼びます。

コレクションには、**同じタイプ**のリソースのリストが含まれます。 たとえば、`users`は`id`と`name`のコレクションを持ちます。

シンプルリソースは、`number`や`string`などの状態か`0`個以上のサブリソースを持ちます。各サブリソースは、シンプルリソースかコレクションリソースのいずれかになります。

リソース指向のAPIは、必ずしもデータベースにマッピングされるわけではありません。リソースやメソッドは柔軟に解釈されます。

たとえば、カレンダーにイベントを作成するAPIの場合、カレンダーの情報のリソースだけでなく、参加者のユーザー情報や会議室の予約情報を複数の設定リソースを持たせ、1APIにまとめることも可能です。

要件に合わせて、リソースとメソッドを設計してください。

#### JSONで利用できるタイプ

| タイプ | 説明 |
| --- | --- |
| string | 文字列 |
| number | 数値 |
| boolean | 真偽値 |
| object | オブジェクト |
| array | 配列 |
| null | null |

### メソッド

RESTfulなAPIでは、リソースに対して実行される操作をメソッドと呼びます。メソッドは、HTTPメソッド（`GET`、`POST`、`PUT`、`PATCH`、`DELETE`）と対応しており、リソースに対する一般的な操作を表現します。

このガイドでは、次の5つの標準メソッドを使用します。

#### GETメソッド

GETメソッドは、リソースを取得します。
GETメソッドが成功すると、通常HTTPステータスコード`200（OK）`がを返却します。

リクエストは成功したが、レスポンスに含まれるデータがない場合、HTTPステータスコード`204（No Content）`を返却します。

例）ユーザーの一覧を取得する

```http
GET https://example.com/user HTTP/1.1
```

例）IDが123のユーザーを取得する

```http
GET https://example.com/user/123 HTTP/1.1
```

#### POSTメソッド

POSTメソッドは、新規にリソースを作成します。
POSTメソッドが成功すると、通常HTTPステータスコード`201（Created）`を返却します。

作成した新しいリソースのURIは、レスポンスの`Location`ヘッダーに含まれています。レスポンスボディーには、作成したリソースが含まれています。作成したリソースをリクエストボディーで返却しない場合、HTTPステータスコード`204（No Content）`を返却します。

クライアントが要求に無効なデータを挿入した場合、サーバーは HTTPステータスコード`400（Bad Request）`を返却します。レスポンスボディーには、エラーに関する内容や情報を提供するURIへのリンクを含めます。

例）新しくユーザーを作成する

```http
POST https://example.com/user HTTP/1.1

{
    "name": "ソルク 太郎",
    "age": 20,
    "company": "株式会社ソルクシーズ",
    "tel": "xxx-xxxx-xxxx",
    "admin": false
}
```

#### PUTメソッド

PUTメソッドは、既存のリソースの更新をします。

PUTメソッドが成功すると、HTTPステータスコード`200（OK）`を返却します。更新したリソースをリクエストボディーで返却しない場合、HTTPステータスコード`204（No Content）`を返却します。

クライアントが要求に無効なデータを挿入した場合、サーバーは HTTPステータスコード`400（Bad Request）`を返却します。

リソースの更新時に、別のユーザーによる同時更新など、更新が競合した場合は、HTTPステータスコード`409（Conflict）`を返却します。

レスポンスボディーには、エラーに関する内容や情報を提供するURIへのリンクを含めます。

例）既存のユーザーを更新する

```http
PUT https://example.com/user/123 HTTP/1.1

{
    "name": "ソルク 太郎",
    "age": 20,
    "company": "株式会社ソルクシーズ",
    "tel": "xxx-xxxx-xxxx",
    "admin": false
}
```

PUTメソッドを作成と更新の両方に使用することも一般的です。

どちらの方式を採用する場合でも、一貫性を保ったAPI設計にしましょう。

#### PATCHメソッド

PATCHメソッドは、既存のリソースの部分的な更新をします。PUTメソッドとは異なり、PATCHメソッドでは更新したい属性のみを指定できます。

PATCHメソッドが成功すると、HTTPステータスコード`200（OK）`を返却します。更新したリソースをリクエストボディーで返却しない場合、HTTPステータスコード`204（No Content）`を返却します。

クライアントが要求に無効なデータを挿入した場合、サーバーは HTTPステータスコード`400（Bad Request）`を返却します。

リソースの更新時に、別のユーザーによる同時更新など、更新が競合した場合は、HTTPステータスコード`409（Conflict）`を返却します。

レスポンスボディーには、エラーに関する内容や情報を提供するURIへのリンクを含めます。

例）既存のユーザーの一部の属性を更新する

```http
PATCH https://example.com/user/123 HTTP/1.1

{
    "name": "ソルク 太郎"
}
```

PATCHメソッドを使うことで、必要な属性のみを更新でき、ネットワークのオーバーヘッドを減らすことができます。ただし、PATCHメソッドはPUTメソッドほど広くサポートされていないため、クライアントがPATCHメソッドをサポートしているか確認する必要があります。

#### DELETEメソッド

DELETEメソッドは、既存のリソースを削除します。

DELETEメソッドが成功すると、HTTPステータスコード`200（OK）`を返却します。削除したリソースをレスポンスボディーで返却する場合は、HTTPステータスコード`200（OK）`を返却します。削除したリソースをレスポンスボディーで返却しない場合、HTTPステータスコード`204（No Content）`を返却します。

指定したリソースが存在しない場合、HTTPステータスコード`404（Not Found）`を返却します。

例）既存のユーザーを削除する

```http
DELETE https://example.com/user/123 HTTP/1.1
```

DELETEメソッドは、リソースを完全に削除します。リソースを論理的に削除する（例：`isDeleted`フラグを設定する）場合は、PUTまたはPATCHメソッドを使用します。

以上が、REST APIで一般的に使用される5つの標準メソッド（GET、POST、PUT、PATCH、DELETE）です。これらのメソッドを適切に使い分けることで、一貫性のあるわかりやすいAPIを設計することができます。

#### カスタムメソッド

これらの標準メソッドで対応できない操作については、カスタムメソッドを定義することができます。カスタムメソッドは、APIの要件に応じて柔軟に設計できます。

たとえば、ユーザーのパスワードをリセットする操作は標準メソッドでは表現しづらいため、次のようなカスタムメソッドを定義することができます。

- `POST /user/123/reset-password` - IDが123のユーザーのパスワードをリセットする

リソースとメソッドを適切に組み合わせることで、直感的で一貫性のあるAPIを設計することができます。

#### まとめ

| リソース | POST | GET | PUT | PATCH |DELETE |
|---------|------|-----|-----|--------|--------|
| /user | 新しいユーザーを作成 | すべてのユーザーを取得 | ユーザーを一括更新 | ユーザーの一部の情報を一括更新 | すべてのユーザーを削除 |
| /user/123 | エラー | ユーザー123を取得 | ユーザー123の更新 | ユーザー123の一部の情報を更新 | ユーザー123を削除 |
| /user/123/reset-password | ユーザー123のパスワードをリセット | エラー | エラー | エラー | エラー |
